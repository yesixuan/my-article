---
title: 互联网协议入门（二）
tags: ["协议"]
date: 2018-04-02 18:00:00
categories:
- 计算机
- 互联网协议
---
> 互联网协议解决的问题是：两台计算机是如何进行通讯的...

<!-- more -->
前文从宏观上讲了互联网协议的分层，以及每一层的角色。但遗留了一个小问题。下面我们来讲讲这个问题，以及从用户的角度如何理解互联网协议。  

## 遗留问题

当发送者与接收者不在同一个子网络时，如何得到接收者的mac地址呢？  
![两台主机不在一个子网络的情况](http://www.ruanyifeng.com/blogimg/asset/201206/bg2012061101.jpg)  
上图中，1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是（后文介绍判断方法），于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑位于子网络B，又把数据包发给网关B，网关B再转发到4号电脑。  

## 上网必备的四个参数  

这四个参数就相当于互联网世界的身份证。有了这个身份证，我们才能给别人发消息，也才能让别人找到我。  
这个身份证包含的信息有：DNS的IP地址、网关的IP地址、本机的IP地址、子网的掩码（可以理解为省市区）。  

如果我们给每一台计算机配置上述四个参数（即静态IP上网）会存在两个问题：① 这般配置对于普通用户来说太过专业，让人望而生畏；② 这几个参数一旦被一个人占用，那么其他人便不能使用。  

### 动态IP地址

基于静态IP的缺陷，大多数人使用的还是动态IP地址的方式上网。而动态地给计算机分配IP地址，需要用到DHCP协议（一种应用层协议，建立在UDP协议之上）。  

这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请IP地址和相关的网络参数。 

## 从互联网协议的角度来看我们访问网页的过程

1. 根据网址查询IP地址：  
已知DNS服务器为8.8.8.8，于是我们向这个地址发送一个DNS数据包（53端口）。
然后，DNS服务器做出响应，告诉我们Google的IP地址是172.194.72.105。于是，我们知道了对方的IP地址。  

2. 判断本机与对方的IP地址是否在同一个子网络：  
根据子网掩码（子网掩码在何时拿到的？）分别与本机IP、对方IP做ADN运算，最终判断本机与对方的IP地址是否在同一个子网络  

3. 将http数据包的全部内容嵌入到TCP协议的数据包中（TCP协议的数据包实际上含有多个标头与该http请求的全部内容）  

4. TCP协议：  
TCP数据包需要设置端口，接收方（Google）的HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024-65535之间的整数，假定为51775。  

5. IP协议  
然后，TCP数据包再嵌入IP数据包。IP数据包需要设置双方的IP地址，这是已知的，发送方是192.168.1.100（本机），接收方是172.194.72.105（Google）。  

6. 以太网协议  
最后，IP数据包嵌入以太网数据包。以太网数据包需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关192.168.1.1的MAC地址（通过ARP协议得到）。  

7. 服务器响应  
经过多个网关的转发，Google的服务器172.194.72.105，收到了这四个以太网数据包。  
根据IP标头的序号，Google将多个包拼起来，取出完整的TCP数据包，然后读出里面的"HTTP请求"，接着做出"HTTP响应"，再用TCP协议发回来。  
本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。  

参考文章：  
[互联网协议入门（二）](http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html)